---
import googleplayScreenshotsConfig from '../googleplay-screenshots.config.json';

interface Props {
  t: any;
  lang?: string;
}

const { t, lang = 'en' } = Astro.props;

// 使用 Google Play 截图
const gpConfig = googleplayScreenshotsConfig[lang as keyof typeof googleplayScreenshotsConfig];
const screenshots = gpConfig?.files || [];

// 截图数量（用于 JavaScript）
const screenshotCount = screenshots.length;

// 容器尺寸 - Google Play: 662x1440 (比例 0.46) -> 宽度 280px, 高度 ~609px
const containerWidth = 280;
const containerHeight = 609;
const padding = 16;
const outerWidth = containerWidth + (padding * 2);
---

<section class="relative flex items-center min-h-screen px-6 py-12 md:py-16 overflow-hidden">
  <!-- 流动星云背景 -->
  <div class="cosmic-nebula nebula-1"></div>
  <div class="cosmic-nebula nebula-2"></div>
  <div class="cosmic-nebula nebula-3"></div>

  <div class="relative z-10 max-w-7xl mx-auto w-full">
    <div class="flex flex-col lg:flex-row items-center gap-12 lg:gap-16">
      <!-- 左侧内容区 -->
      <div class="flex-1 text-left lg:pr-8">
        <!-- 品牌头部 - Logo + 名称 + 标签 -->
        <div class="flex items-center gap-4 mb-6 animate-reveal" style="animation-delay: 0.05s;">
          <div class="relative group">
            <!-- Logo发光效果 -->
            <div class="absolute -inset-2 bg-gradient-to-r from-[var(--hydrogen-pink)] via-[var(--carbon-purple)] to-[var(--nitrogen-cyan)] rounded-2xl blur-lg opacity-60 group-hover:opacity-80 transition-opacity duration-500"></div>
            <!-- Logo图标容器 -->
            <div class="relative glass-strong rounded-xl overflow-hidden">
              <img src="/images/icon.webp" alt="Stargazing Hub" class="w-12 h-12" />
            </div>
          </div>
          <!-- 应用名称 + 平台标签 -->
          <div class="flex flex-col">
            <span class="text-2xl font-bold tracking-tight">{t.brand?.name}</span>
            <div class="inline-flex items-center gap-2 mt-1 px-2.5 py-0.5 rounded-full glass">
              <span class="relative flex h-1.5 w-1.5">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[var(--hydrogen-pink)] opacity-75"></span>
                <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-[var(--hydrogen-pink)]"></span>
              </span>
              <span class="text-[10px] text-[var(--text-muted)] tracking-wider uppercase">{t.hero.platformLabel}</span>
            </div>
          </div>
        </div>

        <!-- 主标题 -->
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4 animate-reveal" style="animation-delay: 0.1s;">
          <span class="gradient-text">{t.hero.title}</span>
        </h1>

        <!-- 副标题 -->
        <p class="text-xl md:text-2xl text-[var(--text-secondary)] mb-4 max-w-lg animate-reveal" style="animation-delay: 0.2s;">
          {t.hero.subtitle}
        </p>

        <!-- 描述 -->
        <p class="text-sm md:text-base text-[var(--text-muted)] mb-8 max-w-lg leading-relaxed animate-reveal" style="animation-delay: 0.3s;">
          {t.hero.description}
        </p>

        <!-- 下载按钮组 -->
        <div class="flex flex-col sm:flex-row gap-4 mb-8 animate-reveal" style="animation-delay: 0.4s;">
          <a
            href={t.links?.appStore}
            target="_blank"
            rel="noopener noreferrer"
            class="btn-primary group flex items-center gap-4 text-lg px-10 py-5"
          >
            <svg class="w-10 h-10" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
            </svg>
            <div class="text-left">
              <div class="text-xs opacity-80">{t.download.appStore}</div>
              <div class="font-bold">App Store</div>
            </div>
          </a>

          <a
            href={t.links?.googlePlay}
            target="_blank"
            rel="noopener noreferrer"
            class="btn-primary group flex items-center gap-4 text-lg px-10 py-5"
            style="--gradient-nebula: linear-gradient(135deg, #4ECDC4 0%, #22D3EE 50%, #A855F7 100%);"
          >
            <svg class="w-10 h-10" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3,20.5V3.5C3,2.91 3.34,2.39 3.84,2.15L13.69,12L3.84,21.85C3.34,21.6 3,21.09 3,20.5M16.81,15.12L6.05,21.34L14.54,12.85L16.81,15.12M20.16,10.81C20.5,11.08 20.75,11.5 20.75,12C20.75,12.5 20.53,12.9 20.18,13.18L17.89,14.5L15.39,12L17.89,9.5L20.16,10.81M6.05,2.66L16.81,8.88L14.54,11.15L6.05,2.66Z" />
            </svg>
            <div class="text-left">
              <div class="text-xs opacity-80">{t.download.googlePlay}</div>
              <div class="font-bold">Google Play</div>
            </div>
          </a>
        </div>

        <!-- 统计数据 - 紧凑卡片 -->
        <div class="flex flex-wrap gap-4 animate-reveal" style="animation-delay: 0.5s;">
          <div class="glass px-4 py-3 rounded-xl flex items-center gap-3">
            <div class="text-2xl font-bold gradient-text-warm">{t.hero.stats?.downloads?.value}</div>
            <div class="text-xs text-[var(--text-muted)]">{t.hero.stats?.downloads?.label}</div>
          </div>
          <div class="glass px-4 py-3 rounded-xl flex items-center gap-3">
            <div class="flex items-center gap-1">
              <svg class="w-4 h-4 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <span class="text-2xl font-bold gradient-text-cool">{t.hero.stats?.rating?.value}</span>
            </div>
            <div class="text-xs text-[var(--text-muted)]">{t.hero.stats?.rating?.label}</div>
          </div>
          <div class="glass px-4 py-3 rounded-xl flex items-center gap-3">
            <div class="text-2xl font-bold gradient-text">{t.hero.stats?.languages?.value}</div>
            <div class="text-xs text-[var(--text-muted)]">{t.hero.stats?.languages?.label}</div>
          </div>
        </div>
      </div>

      <!-- 右侧截图区 - 扇形画廊 -->
      <div class="flex-1 flex justify-center lg:justify-end items-center w-full" style="animation-delay: 0.3s;">
        <div class="gallery-container relative transform scale-[0.6] sm:scale-[0.7] md:scale-[0.8] lg:scale-100 origin-center lg:origin-right" style="width: 100%; max-width: 1200px; height: 600px;">
          <!-- 背景光晕 -->
          <div class="absolute inset-0 bg-gradient-to-r from-[var(--hydrogen-pink)] via-[var(--carbon-purple)] to-[var(--nitrogen-cyan)] rounded-[3rem] blur-3xl opacity-15"></div>

          <!-- 扇形卡片容器 -->
          <div class="relative w-full h-full flex items-center justify-start pl-0" id="fan-gallery">
            {
              screenshots.map((screenshot, index) => {
                // 左侧主卡片 + 右侧堆叠（7张卡片）
                const maxDisplay = 7;
                const pos = index % maxDisplay;
                const xOffset = pos === 0 ? 0 : 65 + (pos - 1) * 40; // 0, 65, 105, 145, 185, 225, 265
                const scale = pos === 0 ? 1 : 0.96 - (pos - 1) * 0.06; // 1, 0.96, 0.90, 0.84, 0.78, 0.72, 0.66
                const opacity = pos === 0 ? 1 : 0.93 - (pos - 1) * 0.12; // 1, 0.93, 0.81, 0.69, 0.57, 0.45, 0.33
                const blur = pos === 0 ? 0 : (pos - 1) * 0.15; // 0, 0, 0.15, 0.3, 0.45, 0.6, 0.75
                const zIndex = 100 - pos;

                return (
                  <div
                    class="gallery-card absolute cursor-pointer transition-all duration-500 ease-out"
                    id={`gallery-card-${index}`}
                    data-index={index}
                    style={`
                      left: ${xOffset}px;
                      transform: scale(${scale});
                      opacity: ${opacity};
                      filter: blur(${blur}px);
                      z-index: ${zIndex};
                    `}
                  >
                    <div class="card-frame w-[280px] h-[609px] rounded-2xl overflow-hidden shadow-2xl border border-white/20 bg-[var(--cosmic-void)]">
                      <img
                        src={screenshot}
                        alt={`${t.brand?.name} ${index + 1}`}
                        class={`w-full h-full object-cover ${pos !== 0 ? 'grayscale' : ''}`}
                        loading={index < 5 ? 'eager' : 'lazy'}
                      />
                    </div>
                  </div>
                )
              })
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 滚动指示器 -->
  <div class="absolute bottom-8 left-1/2 -translate-x-1/2 animate-bounce z-20">
    <svg class="w-6 h-6 text-[var(--text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
    </svg>
  </div>
</section>

<script is:inline>
  // 扇形画廊轮播
  (function() {
    let cardOrder = [];
    let autoPlayInterval = null;
    const maxDisplay = 7; // 同时显示 7 张卡片

    // 初始化扇形画廊
    function initFanGallery() {
      const cards = document.querySelectorAll('.gallery-card');
      const totalCards = cards.length;

      if (totalCards === 0) return;

      // 初始化卡片顺序
      cardOrder = Array.from({ length: totalCards }, (_, i) => i);

      // 为每张卡片添加点击事件
      cards.forEach((card) => {
        card.addEventListener('click', function() {
          const clickedIndex = parseInt(this.getAttribute('data-index'));
          if (!isNaN(clickedIndex)) {
            bringToCenter(clickedIndex);
          }
        });

        // 悬停暂停
        card.addEventListener('mouseenter', () => {
          if (autoPlayInterval) {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
          }
        });

        card.addEventListener('mouseleave', () => {
          startAutoPlay();
        });
      });

      // 启动自动播放
      startAutoPlay();
    }

    // 将指定卡片移到中心
    function bringToCenter(cardIndex) {
      cardOrder = cardOrder.filter(i => i !== cardIndex);
      cardOrder.unshift(cardIndex);
      updateCards();
    }

    // 更新所有卡片的位置
    function updateCards() {
      const cards = document.querySelectorAll('.gallery-card');
      const isMobile = window.innerWidth < 1024; // 检查是否为移动端

      cardOrder.forEach((cardIndex, position) => {
        if (position >= maxDisplay) {
          // 超出显示范围的卡片隐藏
          const card = document.querySelector(`#gallery-card-${cardIndex}`);
          if (card) {
            card.style.opacity = '0';
            card.style.pointerEvents = 'none';
          }
          return;
        }

        const card = document.querySelector(`#gallery-card-${cardIndex}`);
        if (card) {
          const img = card.querySelector('img');

          let xOffset, scale, opacity, blur, zIndex;

          if (isMobile) {
             // 移动端：居中堆叠模式 (Centered Stack)
             // 所有的卡片都居中，只通过缩放和透明度区分
             xOffset = 0; // 不再向右偏移
             
             // 稍微向下的垂直偏移，制造堆叠感
             const yOffset = position * 15; 
             card.style.top = `${yOffset}px`;
             
             scale = 1 - (position * 0.05); // 1, 0.95, 0.90...
             opacity = position === 0 ? 1 : 1 - (position * 0.15);
             blur = position === 0 ? 0 : position * 2;
             zIndex = 100 - position;
             
             // 修正居中
             card.style.left = '50%';
             card.style.marginLeft = '-140px'; // 宽度的一半 (280/2)
          } else {
             // 桌面端：原有的扇形展开模式
             card.style.top = '0px'; // 重置 top
             card.style.marginLeft = '0px'; // 重置 margin

             xOffset = position === 0 ? 0 : 65 + (position - 1) * 40;
             scale = position === 0 ? 1 : 0.96 - (position - 1) * 0.06;
             opacity = position === 0 ? 1 : 0.93 - (position - 1) * 0.12;
             blur = position === 0 ? 0 : (position - 1) * 0.15;
             zIndex = 100 - position;
             
             card.style.left = `${xOffset}px`;
          }

          card.style.transform = `scale(${scale})`;
          card.style.opacity = opacity;
          card.style.filter = `blur(${blur}px)`;
          card.style.zIndex = zIndex;
          card.style.pointerEvents = 'auto';

          // 只有第一张（最左边/最上面）是彩色的
          if (img) {
            if (position === 0) {
              img.classList.remove('grayscale');
            } else {
              img.classList.add('grayscale');
            }
          }
        }
      });
    }

    // 监听窗口大小变化
    window.addEventListener('resize', () => {
       updateCards();
    });

    // 下一张
    function nextCard() {
      if (cardOrder.length > 1) {
        const firstCard = cardOrder.shift();
        cardOrder.push(firstCard);
        updateCards();
      }
    }

    // 启动自动播放
    function startAutoPlay() {
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
      }
      autoPlayInterval = setInterval(nextCard, 3000);
    }

    // 初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFanGallery);
    } else {
      initFanGallery();
    }
  })();
</script>

<style define:vars={{ containerWidth, containerHeight }}>
  /* Hero 区域特定动画 */
  @keyframes pulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.5; }
  }

  /* 堆叠轮播容器 */
  .stack-carousel-container {
    overflow: visible;
  }

  /* 堆叠卡片 */
  .stack-card {
    will-change: left, z-index, transform, opacity, filter;
    position: absolute;
    transform-origin: center left;
  }

  /* 截图卡片 */
  .screenshot-card {
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
    background: #1a1a2e;
  }

  /* 截图图片 */
  .screenshot-img {
    transition: filter 0.7s ease;
  }

  /* 画廊容器 */
  .gallery-container {
    perspective: 1200px;
  }

  /* 画廊卡片 */
  .gallery-card {
    will-change: transform, opacity, filter;
    position: absolute;
    transform-style: preserve-3d;
  }

  /* 卡片边框 */
  .card-frame {
    transition: box-shadow 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
  }

  /* 悬停效果 */
  .gallery-card:hover .card-frame {
    box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.8),
                0 0 25px rgba(224, 64, 128, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
    transform: scale(1.02);
  }
</style>
