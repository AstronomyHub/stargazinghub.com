---
interface Props {
  t: any;
}

const { t } = Astro.props;

const testimonials = t.testimonials?.reviews || [];
const upcomingEvents = t.testimonials?.events || [];

// Icon helper function - redesigned with better astronomical visuals
const getIconPath = (type: string) => {
  const typeLower = type?.toLowerCase() || '';

  // Planetary Opposition - Saturn with rings
  if (typeLower.includes('planet') || typeLower.includes('行星') || typeLower.includes('惑星') || typeLower.includes('planeta') || typeLower.includes('planetar') || typeLower.includes('планета')) {
    return "M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm-8-3l-2 1c.73 1.63 1.73 3.01 2.87 4.13l1.41-1.41C4.79 15.41 3.96 14.26 3.33 13zm17.34 0c-.63 1.26-1.46 2.41-2.28 3.72l1.41 1.41c1.14-1.12 2.14-2.5 2.87-4.13l-2-1zM12 3c-1.1 0-2 .9-2 2v2h4V5c0-1.1-.9-2-2-2zm-6.36 2.64l-1.41-1.41C3.01 5.69 2 7.26 2 9h2c0-1.1.45-2.1 1.18-2.82l.46-.54zm12.72 0l.46.54C17.55 6.9 18 7.9 18 9h2c0-1.74-1.01-3.31-2.59-4.05l-1.41 1.41z";
  }

  // Lunar Eclipse - Moon with shadow/blood moon
  if (typeLower.includes('lunar') || typeLower.includes('月') || typeLower.includes('lun') || typeLower.includes('달') || typeLower.includes('лун') || typeLower.includes('maan')) {
    return "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z";
  }

  // Solar Eclipse - Sun with corona
  if (typeLower.includes('solar') || typeLower.includes('太陽') || typeLower.includes('太阳') || typeLower.includes('sol') || typeLower.includes('태양') || typeLower.includes('солн') || typeLower.includes('zon')) {
    return "M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 8c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000 1.41.996.996 0 001.41 0l1.06-1.06c.39-.39.39-1.03 0-1.41s-1.03-.39-1.41 0l-1.06 1.06z";
  }

  // Meteor Shower - shooting star with trail
  return "M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z";
};
---

<section class="relative isolate py-16 sm:py-24 px-3 sm:px-4 overflow-hidden max-w-full before:content-[''] before:absolute before:w-[300px] before:h-[300px] sm:before:w-[500px] sm:before:h-[500px] before:bg-accent/20 before:rounded-full before:blur-[100px] before:top-1/4 before:left-[-100px] sm:before:left-[-200px] before:pointer-events-none before:-z-10 after:content-[''] after:absolute after:w-[250px] after:h-[250px] sm:after:w-[400px] sm:after:h-[400px] after:bg-accent-cyan/20 after:rounded-full after:blur-[100px] after:bottom-1/4 after:right-[-75px] sm:after:right-[-150px] after:pointer-events-none after:-z-10">

  <div class="relative z-10 max-w-7xl mx-auto">
    <div class="grid lg:grid-cols-2 gap-12 lg:gap-16">
      <!-- User Reviews Section -->
      <div class="overflow-hidden">
        <div class="inline-flex items-center gap-2 px-3 py-1.5 sm:px-4 sm:py-2 rounded-full glass mb-4 sm:mb-6">
          <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-accent shrink-0" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          <span class="text-xs sm:text-sm text-text-secondary shrink-0">{t.testimonials?.reviewsLabel || 'User Reviews'}</span>
        </div>

        <h2 class="font-display text-xl sm:text-2xl md:text-3xl lg:text-4xl font-bold mb-6 sm:mb-8 pr-1">
          <span class="gradient-text break-words">{t.testimonials?.title}</span>
        </h2>

        <div class="space-y-4 sm:space-y-6">
          {testimonials.map((testimonial: any, index: number) => (
            <div class="group relative bg-gradient-to-br from-surface/80 to-primary/80 backdrop-blur-sm rounded-2xl p-3 sm:p-4 md:p-6 border border-white/10 hover:border-accent/50 transition-all duration-500">
              <div class="absolute inset-0 bg-gradient-to-r from-accent to-accent-cyan rounded-2xl blur opacity-0 group-hover:opacity-20 transition-opacity duration-500 -z-10"></div>

              <div class="flex items-start gap-2.5 sm:gap-3 md:gap-4 w-full overflow-hidden">
                <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-full bg-gradient-to-br from-accent to-accent-cyan flex items-center justify-center text-white font-bold text-sm sm:text-base md:text-lg shrink-0">
                  {testimonial.name.charAt(0)}
                </div>

                <div class="flex-1 min-w-0 w-full">
                  <div class="flex items-center gap-1 mb-2" aria-label="5 stars" role="img">
                    {Array.from({ length: 5 }).map(() => (
                      <svg class="w-3 h-3 sm:w-3.5 sm:h-3.5 md:w-4 md:h-4 text-accent shrink-0" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      </svg>
                    ))}
                  </div>

                  <p class="text-text-secondary text-xs sm:text-sm md:text-base mb-2 sm:mb-3 break-words w-full leading-relaxed">"{testimonial.text}"</p>

                  <div class="flex flex-wrap items-center gap-1 text-xs sm:text-sm w-full min-w-0">
                    <span class="text-white font-medium truncate">{testimonial.name}</span>
                    <span class="text-text-secondary shrink-0"> · </span>
                    <span class="text-text-secondary truncate">{testimonial.location}</span>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Upcoming Events Section -->
      <div class="overflow-hidden">
        <div class="inline-flex items-center gap-2 px-3 py-1.5 sm:px-4 sm:py-2 rounded-full glass mb-4 sm:mb-6">
          <div class="relative flex h-2 w-2 shrink-0">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-accent-cyan opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-accent-cyan"></span>
          </div>
          <span class="text-xs sm:text-sm text-text-secondary uppercase tracking-widest shrink-0">{t.testimonials?.eventsLabel || 'Upcoming Events'}</span>
        </div>

        <div class="mb-6 sm:mb-8">
          <h2 class="font-display text-xl sm:text-2xl md:text-3xl lg:text-4xl font-bold leading-tight pr-1">
            <span class="gradient-text-cyan mr-2 inline-block align-middle">{t.testimonials?.subtitle}</span>
            <span class="inline-block text-xs sm:text-sm font-normal text-accent-cyan border border-accent-cyan/30 px-2 py-0.5 rounded align-middle whitespace-nowrap">2026</span>
          </h2>
        </div>

        <!-- Carousel Container -->
        <div class="relative">
          <!-- Carousel Wrapper -->
          <div id="events-carousel" class="overflow-hidden rounded-xl">
            <div id="events-track" class="flex transition-transform duration-500 ease-in-out">
              <!-- First Slide (4 events) -->
              <div class="w-full flex-shrink-0 space-y-3 sm:space-y-4 p-1.5 sm:p-2 md:p-3">
                {upcomingEvents.slice(0, 4).map((event: any, index: number) => (
                  <div class="group relative bg-gradient-to-br from-surface/80 to-primary/80 backdrop-blur-sm rounded-xl p-3 sm:p-4 md:p-5 border border-white/10 hover:border-accent-cyan/50 transition-all duration-500">
                    <div class="absolute inset-0 bg-gradient-to-r from-accent-cyan to-accent rounded-xl blur opacity-0 group-hover:opacity-20 transition-opacity duration-500 -z-10"></div>

                    <!-- Mobile: Vertical Stack / Desktop: Horizontal Layout -->
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-3">
                      <div class="flex items-start gap-2 sm:gap-3 min-w-0 w-full sm:flex-1">
                        <div class="w-9 h-9 sm:w-10 sm:h-10 md:w-14 md:h-14 shrink-0 rounded-lg bg-gradient-to-br from-accent-cyan/20 to-accent/20 flex items-center justify-center border border-accent-cyan/10">
                          <svg class="w-4.5 h-4.5 sm:w-5 sm:h-5 md:w-7 md:h-7 text-accent-cyan" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path d={getIconPath(event.type)} stroke="none" />
                          </svg>
                        </div>

                        <div class="min-w-0 flex-1 w-full overflow-hidden">
                          <h3 class="text-sm sm:text-base md:text-lg font-bold text-white group-hover:text-accent-cyan transition-colors truncate pr-1 w-full">{event.name}</h3>
                          <div class="flex items-center gap-2 min-w-0 mt-1">
                            <span class="inline-flex text-[10px] sm:text-xs uppercase tracking-wider px-1.5 py-0.5 rounded bg-accent-cyan/10 text-accent-cyan border border-accent-cyan/20 max-w-[5rem] sm:max-w-[6rem] md:max-w-[10rem] truncate">
                              {event.type}
                            </span>
                          </div>
                        </div>
                      </div>

                      <!-- Date Section - Mobile: Small and Compact / Desktop: Aligned Right -->
                      <div class="flex items-center sm:justify-end shrink-0">
                        <p class="text-accent-cyan font-medium text-xs sm:text-sm md:text-base truncate">{event.date}</p>
                        <p class="text-[9px] sm:text-[10px] md:text-xs text-text-secondary ml-1 sm:ml-2 truncate sm:block">{event.peak}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              <!-- Second Slide (remaining events) -->
              {upcomingEvents.length > 4 && (
                <div class="w-full flex-shrink-0 space-y-3 sm:space-y-4 p-1.5 sm:p-2 md:p-3">
                  {upcomingEvents.slice(4).map((event: any, index: number) => (
                    <div class="group relative bg-gradient-to-br from-surface/80 to-primary/80 backdrop-blur-sm rounded-xl p-3 sm:p-4 md:p-5 border border-white/10 hover:border-accent-cyan/50 transition-all duration-500">
                      <div class="absolute inset-0 bg-gradient-to-r from-accent-cyan to-accent rounded-xl blur opacity-0 group-hover:opacity-20 transition-opacity duration-500 -z-10"></div>

                      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-3">
                        <div class="flex items-start gap-2 sm:gap-3 min-w-0 w-full sm:flex-1">
                          <div class="w-9 h-9 sm:w-10 sm:h-10 md:w-14 md:h-14 shrink-0 rounded-lg bg-gradient-to-br from-accent-cyan/20 to-accent/20 flex items-center justify-center border border-accent-cyan/10">
                            <svg class="w-4.5 h-4.5 sm:w-5 sm:h-5 md:w-7 md:h-7 text-accent-cyan" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                              <path d={getIconPath(event.type)} stroke="none" />
                            </svg>
                          </div>

                          <div class="min-w-0 flex-1 w-full overflow-hidden">
                            <h3 class="text-sm sm:text-base md:text-lg font-bold text-white group-hover:text-accent-cyan transition-colors truncate pr-1 w-full">{event.name}</h3>
                            <div class="flex items-center gap-2 min-w-0 mt-1">
                              <span class="inline-flex text-[10px] sm:text-xs uppercase tracking-wider px-1.5 py-0.5 rounded bg-accent-cyan/10 text-accent-cyan border border-accent-cyan/20 max-w-[5rem] sm:max-w-[6rem] md:max-w-[10rem] truncate">
                                {event.type}
                              </span>
                            </div>
                          </div>
                        </div>

                        <div class="flex items-center sm:justify-end shrink-0">
                          <p class="text-accent-cyan font-medium text-xs sm:text-sm md:text-base truncate">{event.date}</p>
                          <p class="text-[9px] sm:text-[10px] md:text-xs text-text-secondary ml-1 sm:ml-2 truncate sm:block">{event.peak}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          <!-- Navigation Arrows -->
          {upcomingEvents.length > 4 && (
            <div class="flex justify-center gap-3 sm:gap-4 mt-4 sm:mt-6">
              <button id="prev-btn" class="p-2 sm:p-3 rounded-full glass hover:bg-accent-cyan/20 transition-all duration-300 group" aria-label="Previous slide">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-accent-cyan group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
              </button>
              <div id="carousel-dots" class="flex items-center gap-2">
                <button class="min-h-[44px] min-w-[44px] w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-accent-cyan" aria-label="Slide 1"></button>
                <button class="min-h-[44px] min-w-[44px] w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-white/20 hover:bg-white/40 transition-all" aria-label="Slide 2"></button>
              </div>
              <button id="next-btn" class="p-2 sm:p-3 rounded-full glass hover:bg-accent-cyan/20 transition-all duration-300 group" aria-label="Next slide">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-accent-cyan group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </button>
            </div>
          )}
        </div>

      </div>
    </div>
  </div>
</section>

<script>
  // Carousel functionality
  const track = document.getElementById('events-track');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const dots = document.querySelectorAll('#carousel-dots button');

  if (track && prevBtn && nextBtn && dots.length > 0) {
    let currentSlide = 0;
    const totalSlides = 2;

    const updateCarousel = () => {
      track.style.transform = `translateX(-${currentSlide * 100}%)`;

      dots.forEach((dot, index) => {
        if (index === currentSlide) {
          dot.classList.remove('bg-white/20', 'hover:bg-white/40');
          dot.classList.add('bg-accent-cyan');
        } else {
          dot.classList.remove('bg-accent-cyan');
          dot.classList.add('bg-white/20', 'hover:bg-white/40');
        }
      });
    };

    prevBtn.addEventListener('click', () => {
      currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
      updateCarousel();
      resetAutoRotate();
    });

    nextBtn.addEventListener('click', () => {
      currentSlide = (currentSlide + 1) % totalSlides;
      updateCarousel();
      resetAutoRotate();
    });

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        currentSlide = index;
        updateCarousel();
        resetAutoRotate();
      });
    });

    // Auto-rotate functionality with pause
    let autoRotateInterval;

    const startAutoRotate = () => {
      if (autoRotateInterval) clearInterval(autoRotateInterval);
      autoRotateInterval = setInterval(() => {
        currentSlide = (currentSlide + 1) % totalSlides;
        updateCarousel();
      }, 5000);
    };

    const stopAutoRotate = () => {
      if (autoRotateInterval) clearInterval(autoRotateInterval);
    };

    const resetAutoRotate = () => {
      stopAutoRotate();
      startAutoRotate();
    };

    // Start auto-rotate
    startAutoRotate();

    // Pause on hover/focus
    const carouselWrapper = document.getElementById('events-carousel').parentElement;
    if (carouselWrapper) {
      carouselWrapper.addEventListener('mouseenter', stopAutoRotate);
      carouselWrapper.addEventListener('mouseleave', startAutoRotate);
      carouselWrapper.addEventListener('focusin', stopAutoRotate);
      carouselWrapper.addEventListener('focusout', startAutoRotate);
    }
  }
</script>
